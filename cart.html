<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>سلة التسوق المتكاملة</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
    .product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; max-width: 300px; }
    .product button { margin-top: 5px; padding: 5px 10px; cursor: pointer; }
    #cart-items div { margin-bottom: 5px; }
    input, button { margin: 5px 0; padding: 8px; width: 100%; max-width: 300px; }
    h1,h2 { margin-top: 20px; }
  </style>
</head>
<body>

<h1>المنتجات</h1>
<div id="products-list"></div>

<h1>سلة التسوق</h1>
<div id="cart-items">جارٍ تحميل السلة...</div>

<h2>Checkout</h2>
<form id="checkout-form">
  <input type="text" name="name" placeholder="الاسم" required>
  <input type="tel" name="phone" placeholder="رقم الهاتف" required>
  <input type="text" name="address" placeholder="العنوان" required>
  <button type="submit">إرسال الطلب</button>
</form>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
  // ======== Firebase Config ========
  const firebaseConfig = {
    apiKey: "AIzaSyBt90XB3t9_MLH8-73wcQpE7fm65Le06FE",
    authDomain: "maher-phone.firebaseapp.com",
    projectId: "maher-phone",
    storageBucket: "maher-phone.firebasestorage.app",
    messagingSenderId: "759903479842",
    appId: "1:759903479842:web:25c32cd6034b413dc4027b",
    measurementId: "G-YV7TS3LDDW"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ======== Helpers ========
  function genId() { return 'id-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9); }
  let guestId = localStorage.getItem('guestId');
  if (!guestId) { guestId = genId(); localStorage.setItem('guestId', guestId); }

  function getCart() { return JSON.parse(localStorage.getItem('cart-' + guestId) || '[]'); }
  function saveCart(items) { localStorage.setItem('cart-' + guestId, JSON.stringify(items)); }

  // ======== Products List ========
  const products = [
    {id:'p1', name:'موبايل', price:2000},
    {id:'p2', name:'سماعة', price:500},
    {id:'p3', name:'شاحن', price:150},
    {id:'p4', name:'غطاء حماية', price:100}
  ];

  function renderProducts() {
    const container = document.getElementById('products-list');
    container.innerHTML = '';
    products.forEach(p => {
      const el = document.createElement('div');
      el.className = 'product';
      el.innerHTML = <strong>${p.name}</strong><br>السعر: ${p.price};
      const btn = document.createElement('button');
      btn.innerText = 'أضف للسلة';
      btn.addEventListener('click', () => addToCart({...p, qty:1}));
      el.appendChild(btn);
      container.appendChild(el);
    });
  }

  // ======== Cart Functions ========
  async function addToCart(product) {
    const cart = getCart();
    const found = cart.find(p => p.id === product.id);
    if (found) found.qty += product.qty;
    else cart.push(product);

    saveCart(cart);
    renderCart();

    try {
      const docRef = db.collection('carts').doc(guestId);
      const docSnap = await docRef.get();
      if(docSnap.exists){
        await docRef.update({
          items: firebase.firestore.FieldValue.arrayUnion(product),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await docRef.set({
          guestId,
          items: [product],
          status: 'new',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    } catch (err) {
      console.error('خطأ أثناء إضافة المنتج للـ Firestore:', err);
    }
  }

  function renderCart() {
    const cart = getCart();
    const container = document.getElementById('cart-items');
    if (!container) return;
    container.innerHTML = '';
    cart.forEach(item => {
      const el = document.createElement('div');
      el.innerText = ${item.name} - ${item.qty} × ${item.price};
      container.appendChild(el);
    });
    if (!cart.length) container.innerText = 'السلة فارغة';
  }

  async function checkout(name, phone, address) {
    const cart = getCart();
    if (!cart.length) { alert('السلة فاضية'); return; }

    try {
      const docRef = db.collection('carts').doc(guestId);
      await docRef.update({
        name,
        phone,
        address,
        status: 'ordered',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      let text = طلب جديد من ${name}%0Aرقم: ${phone}%0Aعنوان: ${address}%0Aسلة:%0A;
      cart.forEach(i => { text += ${i.name} - ${i.qty} × ${i.price}%0A; });

      window.open(https://wa.me/201110112115?text=${text}, '_blank');

      localStorage.removeItem('cart-' + guestId);
      renderCart();
      alert('تم إرسال الطلب! سيتم فتح واتساب لإكمال التواصل.');
    } catch (err) {
      console.error(err);
      alert('حصل خطأ أثناء إرسال الطلب.');
    }
  }

  // ======== DOM Ready ========
  document.addEventListener('DOMContentLoaded', () => {
    renderProducts();
    renderCart();
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
      checkoutForm.addEventListener('submit', e => {
        e.preventDefault();
        const name = checkoutForm.querySelector('[name=name]').value;
        const phone = checkoutForm.querySelector('[name=phone]').value;
        const address = checkoutForm.querySelector('[name=address]').value;
        checkout(name, phone, address);
      });
    }
  });
</script>

</body>
</html>
