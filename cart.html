<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>سلة التسوق التفاعلية</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
    .product, .cart-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; max-width: 300px; }
    .product button, .cart-item button { margin: 5px 5px 0 0; padding: 5px 10px; cursor: pointer; }
    #cart-items div { margin-bottom: 5px; }
    input, button { margin: 5px 0; padding: 8px; width: 100%; max-width: 300px; }
    h1,h2 { margin-top: 20px; }
  </style>
</head>
<body>

<h1>المنتجات</h1>
<div id="products-list"></div>

<h1>سلة التسوق</h1>
<div id="cart-items">جارٍ تحميل السلة...</div>

<h2>Checkout</h2>
<form id="checkout-form">
  <input type="text" name="name" placeholder="الاسم" required>
  <input type="tel" name="phone" placeholder="رقم الهاتف" required>
  <input type="text" name="address" placeholder="العنوان" required>
  <button type="submit">إرسال الطلب</button>
</form>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
  // ======== Firebase Config ========
const firebaseConfig = {
  apiKey: "AIzaSyClVoFpPLnIeGa9yOHY45JE2FG7DHxX3SQ",
  authDomain: "maherphpne.firebaseapp.com",
  projectId: "maherphpne",
  storageBucket: "maherphpne.firebasestorage.app",
  messagingSenderId: "82850236630",
  appId: "1:82850236630:web:618f7dc8c6cc65e20ca177",
  measurementId: "G-LSBKJB470L"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ======== Helpers ========
  function genId() { return 'id-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9); }
  let guestId = localStorage.getItem('guestId');
  if (!guestId) { guestId = genId(); localStorage.setItem('guestId', guestId); }

  function getCart() { return JSON.parse(localStorage.getItem('cart-' + guestId) || '[]'); }
  function saveCart(items) { localStorage.setItem('cart-' + guestId, JSON.stringify(items)); }

  // ======== Products List ========
  const products = [
    {id:'p1', name:'موبايل', price:2000},
    {id:'p2', name:'سماعة', price:500},
    {id:'p3', name:'شاحن', price:150},
    {id:'p4', name:'غطاء حماية', price:100}
  ];

  function renderProducts() {
    const container = document.getElementById('products-list');
    container.innerHTML = '';
    products.forEach(p => {
      const el = document.createElement('div');
      el.className = 'product';
      el.innerHTML = <strong>${p.name}</strong><br>السعر: ${p.price};
      const btn = document.createElement('button');
      btn.innerText = 'أضف للسلة';
      btn.addEventListener('click', () => addToCart({...p, qty:1}));
      el.appendChild(btn);
      container.appendChild(el);
    });
  }

  // ======== Cart Functions ========
  async function addToCart(product) {
    const cart = getCart();
    const found = cart.find(p => p.id === product.id);
    if (found) found.qty += product.qty;
    else cart.push(product);

    saveCart(cart);
    renderCart();

    try {
      const docRef = db.collection('carts').doc(guestId);
      const docSnap = await docRef.get();
      if(docSnap.exists){
        await docRef.update({
          items: firebase.firestore.FieldValue.arrayUnion(product),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await docRef.set({
          guestId,
          items: [product],
          status: 'new',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    } catch (err) {
      console.error('خطأ أثناء إضافة المنتج للـ Firestore:', err);
    }
  }

  function updateCartItem(productId, newQty) {
    let cart = getCart();
    cart = cart.map(p => {
      if (p.id === productId) p.qty = newQty;
      return p;
    }).filter(p => p.qty > 0);
    saveCart(cart);
    renderCart();
  }

  function removeCartItem(productId) {
    let cart = getCart();
    cart = cart.filter(p => p.id !== productId);
    saveCart(cart);
    renderCart();
  }

  function renderCart() {
    const cart = getCart();
    const container = document.getElementById('cart-items');
    if (!container) return;
    container.innerHTML = '';
    cart.forEach(item => {
      const el = document.createElement('div');
      el.className = 'cart-item';
      el.innerHTML = `
        ${item.name} - ${item.qty} × ${item.price}
        <button onclick="updateCartItem('${item.id}', ${item.qty+1})">+</button>
        <button onclick="updateCartItem('${item.id}', ${item.qty-1})">-</button>
        <button onclick="removeCartItem('${item.id}')">حذف</button>
      `;
      container.appendChild(el);
    });
    if (!cart.length) container.innerText = 'السلة فارغة';
  }

  async function checkout(name, phone, address) {
    const cart = getCart();
    if (!cart.length) { alert('السلة فاضية'); return; }

    try {
      const docRef = db.collection('carts').doc(guestId);
      await docRef.update({
        name,
        phone,
        address,
        status: 'ordered',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      let text = طلب جديد من ${name}%0Aرقم: ${phone}%0Aعنوان: ${address}%0Aسلة:%0A;
      cart.forEach(i => { text += ${i.name} - ${i.qty} × ${i.price}%0A; });

      window.open(https://wa.me/201110112115?text=${text}, '_blank');

      localStorage.removeItem('cart-' + guestId);
      renderCart();
      alert('تم إرسال الطلب! سيتم فتح واتساب لإكمال التواصل.');
    } catch (err) {
      console.error(err);
      alert('حصل خطأ أثناء إرسال الطلب.');
    }
  }

  // ======== DOM Ready ========
  document.addEventListener('DOMContentLoaded', () => {
    renderProducts();
    renderCart();
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
      checkoutForm.addEventListener('submit', e => {
        e.preventDefault();
        const name = checkoutForm.querySelector('[name=name]').value;
        const phone = checkoutForm.querySelector('[name=phone]').value;
        const address = checkoutForm.querySelector('[name=address]').value;
        checkout(name, phone, address);
      });
    }
  });

  // لجعل updateCartItem و removeCartItem متاحة في onclick
  window.updateCartItem = updateCartItem;
  window.removeCartItem = removeCartItem;

</script>
</body>
</html>

