<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم الطلبات</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
    h1 { margin-bottom: 10px; }
    .counters { margin-bottom: 20px; }
    .counters span { margin-right: 15px; font-weight: bold; }
    .filter { margin-bottom: 20px; }
    .order { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .order div { margin-bottom: 5px; }
    button { padding: 5px 10px; margin-right: 5px; cursor: pointer; }
  </style>
</head>
<body>

<h1>لوحة التحكم - الطلبات</h1>

<div class="counters">
  <span id="total-count">الكل: 0</span>
  <span id="new-count">جديد: 0</span>
  <span id="ordered-count">تم الطلب: 0</span>
</div>

<div class="filter">
  <label>فلتر حسب الحالة: </label>
  <select id="status-filter">
    <option value="all">الكل</option>
    <option value="new">جديد</option>
    <option value="ordered">تم الطلب</option>
  </select>
</div>

<div id="orders-list">جارٍ تحميل الطلبات...</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
  // ======== Firebase Config ========
  const firebaseConfig = {
    apiKey: "AIzaSyBt90XB3t9_MLH8-73wcQpE7fm65Le06FE",
    authDomain: "maher-phone.firebaseapp.com",
    projectId: "maher-phone",
    storageBucket: "maher-phone.firebasestorage.app",
    messagingSenderId: "759903479842",
    appId: "1:759903479842:web:25c32cd6034b413dc4027b",
    measurementId: "G-YV7TS3LDDW"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentFilter = 'all';

  // ======== Load Orders ========
  async function loadOrders(filter='all') {
    currentFilter = filter;
    const container = document.getElementById('orders-list');
    container.innerHTML = '';
    try {
      let query = db.collection('carts').orderBy('createdAt','desc');
      if(filter !== 'all') query = query.where('status','==',filter);

      const snapshot = await query.get();
      if(snapshot.empty){
        container.innerText = 'لا توجد طلبات حالياً';
        updateCounters([]);
        return;
      }

      const orders = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        orders.push(data);
        const div = document.createElement('div');
        div.className = 'order';
        div.id = doc.id;

        let itemsText = '';
        if(data.items && data.items.length){
          data.items.forEach(item => {
            itemsText += ${item.name} - ${item.qty} × ${item.price}\n;
          });
        }

        div.innerHTML = `
          <div><strong>الاسم:</strong> ${data.name || '-'}</div>
          <div><strong>الهاتف:</strong> ${data.phone || '-'}</div>
          <div><strong>العنوان:</strong> ${data.address || '-'}</div>
          <div><strong>الحالة:</strong> ${data.status || 'new'}</div>
          <div><strong>السلة:</strong><pre>${itemsText}</pre></div>
          <button onclick="updateStatus('${doc.id}')">تغيير الحالة</button>
          <button onclick="deleteOrder('${doc.id}')">حذف الطلب</button>
        `;

        container.appendChild(div);
      });

      updateCounters(orders);

    } catch(err){
      console.error(err);
      container.innerText = 'حدث خطأ أثناء تحميل الطلبات';
      updateCounters([]);
    }
  }

  // ======== Update Counters ========
  function updateCounters(orders) {
    const total = orders.length;
    const newCount = orders.filter(o => o.status === 'new').length;
    const orderedCount = orders.filter(o => o.status === 'ordered').length;

    document.getElementById('total-count').innerText = الكل: ${total};
    document.getElementById('new-count').innerText = جديد: ${newCount};
    document.getElementById('ordered-count').innerText = تم الطلب: ${orderedCount};
  }

  // ======== Update Status ========
  async function updateStatus(orderId){
    try {
      const docRef = db.collection('carts').doc(orderId);
      const doc = await docRef.get();
      if(!doc.exists) return alert('الطلب غير موجود');

      const currentStatus = doc.data().status || 'new';
      const newStatus = currentStatus === 'new' ? 'ordered' : 'new';
      await docRef.update({status: newStatus, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
      loadOrders(currentFilter);
    } catch(err){
      console.error(err);
      alert('حدث خطأ أثناء تغيير الحالة');
    }
  }

  // ======== Delete Order ========
  async function deleteOrder(orderId){
    if(!confirm('هل أنت متأكد من حذف هذا الطلب؟')) return;
    try {
      await db.collection('carts').doc(orderId).delete();
      loadOrders(currentFilter);
    } catch(err){
      console.error(err);
      alert('حدث خطأ أثناء حذف الطلب');
    }
  }

  // ======== Filter Event ========
  document.getElementById('status-filter').addEventListener('change', e => {
    loadOrders(e.target.value);
  });

  // ======== DOM Ready ========
  document.addEventListener('DOMContentLoaded', () => {
    loadOrders();
    // ===== تحديث تلقائي كل ثانيتين =====
    setInterval(() => loadOrders(currentFilter), 2000);
  });
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم Maher</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>لوحة التحكم - إضافة منتجات</h1>

  <form id="product-form">
    <label>اسم المنتج:</label><br>
    <input type="text" id="name" required><br><br>

    <label>السعر:</label><br>
    <input type="number" id="price" required><br><br>

    <label>الوصف:</label><br>
    <textarea id="description" required></textarea><br><br>

    <label>رابط الصورة:</label><br>
    <input type="text" id="image" required><br><br>

    <button type="submit">إضافة المنتج</button>
  </form>

  <div id="status"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Firebase Config -->
  <script src="firebaseConfig.js"></script>

  <!-- Admin JS -->
  <script>
    const form = document.getElementById('product-form');
    const status = document.getElementById('status');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const price = parseInt(document.getElementById('price').value);
      const description = document.getElementById('description').value;
      const image = document.getElementById('image').value;

      db.collection('products').add({
        name,
        price,
        description,
        image
      })
      .then(() => {
        status.textContent = "تم إضافة المنتج بنجاح!";
        form.reset();
      })
      .catch(err => {
        status.textContent = "حدث خطأ: " + err;
      });
    });
  </script>
</body>
</html>

